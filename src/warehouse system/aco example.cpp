#include <iostream>
#include <fstream>
#include <stdlib.h>
#include <time.h>
#include <stdio.h>
#include <vector>
#include <algorithm>


using namespace std;

#define m 100				//?????
#define n 31				//?????

const int NC_max = 1000;		//??????
const double Alpha = 1;		//????????????
const double Beta = 5;		//??????????????
const double Rho = 0.1;		//???????
const double Q = 100;		//?????????
const double C[n][2] =		//?????????
{	{ 1304, 2312 },
	{ 3639, 1315 },
	{ 4177, 2244 },
	{ 3712, 1399 },
	{ 3488, 1535 },
	{ 3326, 1556 },
	{ 3238, 1229 },
	{ 4196, 1004 },
	{ 4312, 790 },
	{ 4386, 570 },
	{ 3007, 1970 },
	{ 2562, 1756 },
	{ 2788, 1491 },
	{ 2381, 1676 },
	{ 1332, 695 },
	{ 3715, 1678 },
	{ 3918, 2179 },
	{ 4061, 2370 },
	{ 3780, 2212 },
	{ 3676, 2578 },
	{ 4029, 2838 },
	{ 4263, 2931 },
	{ 3429, 1908 },
	{ 3507, 2367 },
	{ 3394, 2643 },
	{ 3439, 3201 },
	{ 2935, 3240 },
	{ 3140, 3550 },
	{ 2545, 2357 },
	{ 2778, 2826 },
	{ 2370, 2975 }
};

double D[n][n];			//??????????
double Eta[n][n];		//???????,?D??????
double DeltaTau[n][n];	//???????????
double Tau[n][n];		//??????????
int Tabu[m][n];			//???,???????

double L_best[NC_max];		//??????????????
double L_ave[NC_max];		//??????????????
int R_best[NC_max][n];		//???????????


void ValueInit(void)		//???????
{
	for (int i = 0; i < n; i++)			//??? D[n][n]
	{
		for (int j = 0; j < n; j++)
		{
			if (i != j)
				D[i][j] = pow(pow((C[i][0] - C[j][0]), 2) + pow((C[i][1] - C[j][1]), 2), 0.5);
			else
				D[i][j] = std::numeric_limits<double>::epsilon();
		}
	}

	for (int i = 0; i < n; i++)			//??? Eta[n][n]
		for (int j = 0; j < n; j++)
			Eta[i][j] = 1.0 / D[i][j];

	for (int i = 0; i < n; i++)			//??? DeltaEta[n][n]
		for (int j = 0; j < n; j++)
			DeltaTau[i][j] = 0;

	for (int i = 0; i < n; i++)			//??? Tau[n][n]
		for (int j = 0; j < n; j++)
			Tau[i][j] = 1.0;

	for (int i = 0; i < m; i++)			//??? Tabu[m][n]
		for (int j = 0; j < n; j++)
			Tabu[i][j] = 0;
}

void ValueDisplayTabu(int (*p)[n])	//???,???????, ????
{
	for (int i = 0; i < m; i++)
	{
		for (int j = 0; j < n; j++)
		{
			cout << *(*(p + i) + j) << ' ';
		}
		cout << endl;
	}
}

void ValueDisplayTau(double(*p)[n])		//??????,????
{
	for (int i = 0; i < n; i++)
	{
		for (int j = 0; j < n; j++)
		{
			cout << *(*(p + i) + j) << ' ';
		}
		cout << endl;
	}
}

double rnd(double lower, double uper)	//??lower?uper?????double?????
{
	return  (rand() / (double)RAND_MAX) * (uper - lower) + lower;
}

int main()
{
	//???:????????
	ValueInit();

	int NC = 0;
	while(NC < NC_max)
	{
		//???:?m???????n????
		vector<int> temp;
		for (int i = 0; i < ceil((double)m / (double)n); i++)
		{
			for (int j = 0; j < n; j++)
				temp.push_back(j);
		}

		random_shuffle(temp.begin(), temp.end());	//??temp????????

		for (int i = 0; i < m; i++)
		{
			Tabu[i][0] = temp[i];
		}

		//???:m??????????n???????,???????
		for (int j = 1; j < n; j++)
		{
			for (int i = 0; i < m; i++)
			{
				vector<int> visited;	//?i??????????
				vector<int> J;			//?i?????????
				vector<double> P;		//?i????????????

				double Psum = 0.0;		//????
				double rate = 0.0;		//???
				double choose = 0.0;	//????????
				int to_visit;			//????????

				for (int k = 0; k < j; k++)
					visited.push_back(Tabu[i][k]);	//visited???

				for (int k = 0; k < n; k++)
				{
					if (find(visited.begin(), visited.end(), k) == visited.end())	//?visited?????t
					{
						J.push_back(k);				//J???
						P.push_back(0.0);			//P???
					}
				}
				
				for (int k = 0; k < P.size(); k++)	//???????????
				{
					P[k] = pow(Tau[visited.back()][J[k]], Alpha) * pow(Eta[visited.back()][J[k]], Beta);
					Psum += P[k];
				}
				
				rate = rnd(0.0, Psum);				//???????,??????????
				for (int k = 0; k < P.size(); k++)
				{
					choose += P[k];
					if (choose > rate)
					{
						to_visit = J[k];
						break;
					}
				}

				Tabu[i][j] = to_visit;				//?????
			}
		}

		//???:???????????????
		double L[m];	//????????????,????
		for (int i = 0; i < m; i++)
		{
			L[i] = 0.0;
		}
		for (int i = 0; i < m; i++)
		{
			for (int j = 0; j < n - 1; j++)
			{
				L[i] += D[Tabu[i][j]][Tabu[i][j + 1]];
			}
			L[i] += D[Tabu[i][0]][Tabu[i][n - 1]];
		}
		
		double min_value = L[0];	//?????????????????????
		double sum_value = L[0];	//????????????????????
		int min_index = 0;			//??????????????????
		for (int i = 1; i < m; i++)
		{
			sum_value += L[i];
			if (L[i] < min_value)
			{
				min_value = L[i];
				min_index = i;
			}
		}

		L_best[NC] = min_value;						//??????????
		L_ave[NC] = sum_value / m;					//??????????

		for (int i = 0; i < n; i++)
		{
			R_best[NC][i] = Tabu[min_index][i];		//???????????
		}
		
		cout << NC << ": L_best is " << L_best[NC] << ' ' << "L_ave is " << L_ave[NC] << endl;	//????????

		NC++;	//????

		//???:?????
		for (int i = 0; i < m; i++)
		{
			for (int j = 0; j < n - 1; j++)
			{
				DeltaTau[Tabu[i][j]][Tabu[i][j + 1]] += Q / L[i];	//????????????????
			}
			DeltaTau[Tabu[i][n - 1]][Tabu[i][0]] += Q / L[i];
		}

		for (int i = 0; i < n; i++)
		{
			for (int j = 0; j < n; j++)
			{
				Tau[i][j] = (1 - Rho) * Tau[i][j] + DeltaTau[i][j];	//???????,???????
			}
		}

		for (int i = 0; i < m; i++)			//?????
			for (int j = 0; j < n; j++)
				Tabu[i][j] = 0;
	}
	
	//???:??????
	double min_L = L_best[0];			//?????????
	int min_L_index = 0;				//????????????
	int Shortest_Route[n];				//??????????
	for (int i = 0; i < NC; i++)
	{
		if (L_best[i] < min_L)
		{
			min_L = L_best[i];
			min_L_index = i;
		}
	}

	cout << "The length of the shortest route is " << min_L << endl;
	cout << "The number of iteration is " << min_L_index << endl;
	cout << "The Shortest route is: " << endl << "start";

	for (int i = 0; i < n; i++)		//??????????
	{
		Shortest_Route[i] = R_best[min_L_index][i];
		cout << " -> " << Shortest_Route[i];
	}

	system("pause");
	return 0;
}
